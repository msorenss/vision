# OPC UA Machine Vision (OPC 40100) Implementation

This document details the implementation of the OPC UA interface for the Vision System, specifically focusing on compliance with the **OPC 40100-1 Companion Specification for Machine Vision**.

## 1. Architecture & Compliance

The implementation uses a **Split Architecture** to satisfy both strict standard compliance and ease of use for legacy PLCs.

### 1.1 Namespaces

The server exposes two distinct namespaces:

1. `http://opcfoundation.org/UA/MachineVision` (Index 2): Contains standard OPC 40100 objects.
2. `http://vision-system.local/vision` (Index 3): Contains legacy/custom extensions.

### 1.2 Object Model

The address space is organized as follows:

- **`VisionSystem-40100`** (Standard Compliant Object)
  - Implements `VisionSystemType`.
  - Contains **`VisionStateMachine`** (managing states like `Ready`, `SingleExecution`, `Error`).
  - Exposes standard **Methods**: `StartSingleJob`, `StartContinuous`, `Stop`, `Abort`, `Reset`.
  - Generates **Events**: `ResultReadyEventType` (fired when inference completes).
  - Exposes **Alarms**: `SystemErrorAlarm` (triggered in `Error` state).

- **`VisionSystem-Legacy`** (Simplified Interface)
  - Designed for simpler PLCs that do not support Methods or Events.
  - **`State`** (Int32): Simple integer representation of the state.
  - **`LastResult`** (String): Full JSON payload of the last analysis.
  - **Expanded Result Nodes**:
    - `Result_Class` (String): e.g. "bus".
    - `Result_Score` (Float): e.g. 0.98.
    - `Result_Box` (String): Bounding box coordinates.

## 2. PLC Control Guide

### 2.1 Connection Details

- **Endpoint**: `opc.tcp://<server-ip>:4840/freeopcua/server/`
- **Security**: None (Anonymous) for this version.

### 2.2 State Machine Control

The system follows the standard State Machine.

1. **Startup**: System enters `Preoperational` -> `Ready`.
2. **Running a Job**:
    - Call **`StartSingleJob()`**.
    - State transitions: `Ready` -> `SingleExecution` -> `Ready`.
3. **Continuous Run**:
    - Call **`StartContinuous()`**.
    - State transitions: `Ready` -> `ContinuousExecution`.
    - Call **`Stop()`** to return to `Ready`.
4. **Error Handling**:
    - If an error occurs, State becomes `Error`.
    - To recover, call **`Reset()`**.

### 2.3 Configuration (Dynamic Model Switching)

You can switch the active AI model at runtime.

- **Method**: `SelectModel(ModelName)`
- **Arguments**:
  - `ModelName` (String): Name of the model bundle (e.g. "demo v1" or "bolts/v2").
- **Returns**: "OK" or "Failed".

### 2.4 Receiving Results (Events vs Polling)

**Method A: Events (Recommended / Standard)**
Subscribe to `ResultReadyEvent` on the `VisionSystem` object.

- **Event ID**: Unique identifier for the event.
- **Message**: "Result Ready".
- **ResultId**: Correlation ID for the result.
- **JobId**: ID of the job that triggered the result.

**Method B: Legacy Polling**
Monitor the `VisionSystem-Legacy` object.

1. Read `DisplayCount` to detect new results.
2. Read `Result_Class`, `Result_Score` for data.

## 3. Code Implementation Description

### `backend/app/integrations/opcua_server.py`

The core OPC UA server implementation using `opcua-asyncio`.

- **`VisionOpcUaServer` Class**: Singleton that manages the server lifecycle.
- **`start()`**: Sets up namespaces, creates objects (`VisionSystem`, `VisionStateMachine`), and defines Nodes/Methods.
- **`set_state()`**: Manages state transitions and triggers the `SystemErrorAlarm`.
- **`update_result()`**: Called by the backend when inference is done. Updates Legacy variable nodes and triggers `ResultReadyEvent`.

### `backend/app/integrations/opcua_callbacks.py`

This file acts as a bridge between the isolated OPC UA server and the main FastAPI backend.

- **`setup_opcua_callbacks()`**: Registers async functions that the OPC UA server calls when methods are invoked.
- **`on_select_model`**: Logic to find and load a model using the backend's `engine`.
- **`on_start_single_job`**: Logic to verify backend readiness.

### `backend/app/main.py`

The entry point associated with the FastAPI startup.

- **`@app.on_event("startup")`**: Initializes the `server_instance` callbacks, ensuring the OPC UA server can control the application logic only after the app has started.

### `backend/app/api/routes.py`

- **`_process_integrations()`**: The function that pushes results to the OPC UA server (calling `server.update_result()`) after every HTTP inference.
